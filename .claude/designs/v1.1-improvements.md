# Kinect Football v1.1 - Implementation Design

## 1. VectorMath.h - Shared Utilities

```cpp
#pragma once
#include <k4a/k4a.h>
#include <cmath>

namespace kinect {
namespace math {

constexpr float EPSILON = 1e-5f;

inline float magnitudeSquared(const k4a_float3_t& v) {
    return v.xyz.x * v.xyz.x + v.xyz.y * v.xyz.y + v.xyz.z * v.xyz.z;
}

inline float magnitude(const k4a_float3_t& v) {
    return std::sqrt(magnitudeSquared(v));
}

inline k4a_float3_t normalize(const k4a_float3_t& v) {
    float magSq = magnitudeSquared(v);
    if (magSq < EPSILON * EPSILON) {
        return {0.0f, 0.0f, 0.0f};
    }
    float invMag = 1.0f / std::sqrt(magSq);
    return {v.xyz.x * invMag, v.xyz.y * invMag, v.xyz.z * invMag};
}

inline k4a_float3_t subtract(const k4a_float3_t& a, const k4a_float3_t& b) {
    return {a.xyz.x - b.xyz.x, a.xyz.y - b.xyz.y, a.xyz.z - b.xyz.z};
}

inline float dot(const k4a_float3_t& a, const k4a_float3_t& b) {
    return a.xyz.x * b.xyz.x + a.xyz.y * b.xyz.y + a.xyz.z * b.xyz.z;
}

} // namespace math
} // namespace kinect
```

## 2. UITheme.h - FIFA 2026 Constants

```cpp
#pragma once
#include <imgui.h>

namespace kinect {
namespace theme {

// FIFA 2026 Color Palette
namespace colors {
    constexpr ImU32 NAVY_BG = IM_COL32(10, 22, 40, 255);       // #0A1628
    constexpr ImU32 DEEP_NAVY = IM_COL32(13, 27, 42, 255);     // #0D1B2A
    constexpr ImU32 TEAL = IM_COL32(0, 212, 170, 255);         // #00D4AA
    constexpr ImU32 GOLD = IM_COL32(255, 215, 0, 255);         // #FFD700
    constexpr ImU32 CORAL = IM_COL32(255, 107, 107, 255);      // #FF6B6B
    constexpr ImU32 ORANGE = IM_COL32(255, 159, 67, 255);      // #FF9F43
    constexpr ImU32 WHITE = IM_COL32(255, 255, 255, 255);
    constexpr ImU32 GRAY = IM_COL32(160, 170, 180, 255);
    constexpr ImU32 DARK_BORDER = IM_COL32(61, 90, 128, 200);
}

// Font sizes for kiosk visibility
namespace fonts {
    constexpr float HERO = 120.0f;
    constexpr float TITLE = 56.0f;
    constexpr float HEADING = 40.0f;
    constexpr float BODY = 32.0f;
    constexpr float LABEL = 24.0f;
}

// Animation timing (seconds)
namespace timing {
    constexpr float STATE_TRANSITION = 0.35f;
    constexpr float BUTTON_HOVER = 0.15f;
    constexpr float PULSE_SLOW = 2.0f;
    constexpr float PULSE_FAST = 6.0f;
}

} // namespace theme
} // namespace kinect
```

## 3. SessionManager Fix - scoped_lock

```cpp
// Replace in startSession, endSession, getActiveSession:
std::string SessionManager::startSession(uint32_t playerId) {
    std::scoped_lock lock(activeMutex_, sessionsMutex_);
    // ... rest of implementation
}
```

## 4. MotionHistory Circular Buffer

```cpp
// Replace std::deque with fixed circular buffer:
class MotionHistory {
private:
    static constexpr size_t MAX_HISTORY = 30;
    std::array<JointFrame, MAX_HISTORY> frames_;
    size_t head_ = 0;
    size_t count_ = 0;
    float peakSpeedSquared_ = 0.0f;  // Track incrementally

public:
    void addFrame(const k4a_float3_t& position, uint64_t timestamp,
                  k4abt_joint_confidence_level_t confidence);

    float getPeakSpeedSquared() const { return peakSpeedSquared_; }
    float getSpeedSquared() const;  // Current speed squared
};
```

## 5. Application.cpp UI Improvements

### 5.1 Theme Initialization
```cpp
bool Application::initImGui() {
    // ... existing setup ...

    // Apply FIFA 2026 theme
    ImGuiStyle& style = ImGui::GetStyle();
    style.WindowRounding = 0.0f;
    style.FrameRounding = 12.0f;
    style.FramePadding = ImVec2(24, 16);

    ImVec4* colors = style.Colors;
    colors[ImGuiCol_WindowBg] = ImVec4(0.04f, 0.09f, 0.16f, 0.95f);
    colors[ImGuiCol_Button] = ImVec4(0.00f, 0.83f, 0.67f, 1.00f);
    colors[ImGuiCol_ButtonHovered] = ImVec4(0.00f, 0.93f, 0.77f, 1.00f);
    // ... rest of theme colors
}
```

### 5.2 Goal Visualization with Depth
- Add post thickness (20px)
- Add net diagonal pattern
- Add target crosshair animation
- Add glow on highlighted zone

### 5.3 Skeleton with Effects
- Add glow layer under bones
- Gold highlight for kick foot
- Motion trail during kick animation
- Theme-consistent colors

### 5.4 Score Panel
- Background panel (rounded rect)
- Large time display with color coding
- Animated score increments
- "TIME" and "SCORE" labels

## 6. Error Handling

### 6.1 DirectX Error Checks
```cpp
bool Application::createRenderTarget() {
    ID3D11Texture2D* backBuffer = nullptr;
    HRESULT hr = swapChain_->GetBuffer(0, IID_PPV_ARGS(&backBuffer));
    if (FAILED(hr) || !backBuffer) {
        logError("Failed to get back buffer");
        return false;
    }

    hr = d3dDevice_->CreateRenderTargetView(backBuffer, nullptr, &renderTarget_);
    backBuffer->Release();

    if (FAILED(hr)) {
        logError("Failed to create render target view");
        return false;
    }

    return renderTarget_ != nullptr;
}
```

### 6.2 Friendly Error Display
```cpp
void Application::renderError() {
    // Show "Oops! Give us a moment..." instead of F12 instructions
    // Auto-recovery countdown
    // Staff alert if recovery fails
}
```

## Implementation Order

1. Create `VectorMath.h` and `UITheme.h`
2. Fix SessionManager deadlock (scoped_lock)
3. Fix DirectX error handling
4. Apply FIFA 2026 theme colors
5. Enhance goal visualization
6. Enhance skeleton rendering
7. Add score panel
8. Update countdown timing
9. Fix error display
